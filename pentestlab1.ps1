# pentestlab lab0
# https://github.com/0x4141414141/AutomatedLab-for-Pentesting
# needs AutomatedLab to be installed

New-LabDefinition -Name Lab0 -DefaultVirtualizationEngine HyperV

Add-LabVirtualNetworkDefinition -Name Lab0
Add-LabVirtualNetworkDefinition -Name 'Default Switch' -HyperVProperties @{ SwitchType = 'External'; AdapterName = 'Wi-Fi' }


$roles = Get-LabMachineRoleDefinition -Role RootDC @{ DomainFunctionalLevel = 'Win2012R2'; ForestFunctionalLevel = 'Win2008R2' }
#$postInstallActivity = Get-LabPostInstallationActivity -ScriptFileName PrepareRootDomain.ps1 -DependencyFolder $labSources\PostInstallationActivities\PrepareRootDomain
Add-LabMachineDefinition -Name DC1 -Memory 4GB -OperatingSystem 'Windows Server 2012 R2 Standard Evaluation (Server with a GUI)' -Role $roles -Network Lab0 -DomainName contoso.com 
#-PostInstallationActivity $postInstallActivity

Add-LabMachineDefinition -Name DC2 -Memory 4GB -OperatingSystem 'Windows Server 2016 Standard Evaluation (Desktop Experience)' -Network Lab0 -DomainName contoso.com 


$netAdapter = @()
$netAdapter += New-LabNetworkAdapterDefinition -VirtualSwitch Lab0
$netAdapter += New-LabNetworkAdapterDefinition -VirtualSwitch 'Default Switch' -UseDhcp


Add-LabMachineDefinition -Name Router1 -Memory 2GB -OperatingSystem 'Windows Server 2008 R2 Datacenter (Full Installation)' -Roles Routing -NetworkAdapter $netAdapter -DomainName contoso.com

# Forrest Stuff
#$role = Get-LabMachineRoleDefinition -Role FirstChildDC -Properties @{ ParentDomain = 'contoso.com'; NewDomain = 'forrest2.contoso.com'; DomainFunctionalLevel = 'Win2008R2' }
#Add-LabMachineDefinition -Name F2DC1 -Memory 1GB -OperatingSystem 'Windows Server 2016 Standard Evaluation (Desktop Experience)' -Network Lab0 -DomainName forrest2.contoso.com -Roles $role

#$role = Get-LabMachineRoleDefinition -Role FirstChildDC @{
#   ParentDomain = 'contoso.com'
#   NewDomain = 'emea'
#   DomainFunctionalLevel = 'Win2008R2'
#   SiteName = 'London'

#}
#$postInstallActivity = Get-LabPostInstallationActivity -ScriptFileName 'New-ADLabAccounts 2.0.ps1' -DependencyFolder $labSources\PostInstallationActivities\PrepareFirstChildDomain
#Add-LabMachineDefinition -Name F2DC1 -Memory 1GB -OperatingSystem 'Windows Server 2016 Standard Evaluation (Desktop Experience)' -Network Lab0 -DomainName emea.contoso.com -Roles $role -PostInstallationActivity $postInstallActivity

#Client1 AV Disabled
Add-LabMachineDefinition -Name Client1 -Memory 2GB -Network Lab0 -OperatingSystem 'Windows 10 Pro' -DomainName contoso.com
#Client2 AV Kaspersky
Add-LabMachineDefinition -Name Client2 -Memory 2GB -Network Lab0 -OperatingSystem 'Windows 10 Pro' -DomainName contoso.com
#Client3 AV Sophos
Add-LabMachineDefinition -Name Client3 -Memory 2GB -Network Lab0 -OperatingSystem 'Windows 10 Pro' -DomainName contoso.com

Install-Lab

#Post Install: Deactivation Dance for Defender on Client1
Invoke-LabCommand -ScriptBlock { Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend } -ComputerName Client1 -PassThru -UseLocalCredential -Retries 3 -RetryIntervalInSeconds 20 -AsJob



#Post Install: AV on Client2
Invoke-LabCommand -ScriptBlock {Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))} -ComputerName Client2 -PassThru 
Invoke-LabCommand -ScriptBlock {Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))} -ComputerName Client3 -PassThru
Invoke-LabCommand -ScriptBlock {Set-ExecutionPolicy Bypass -Scope Process -Force; choco install kis -y -force} -ComputerName Client2 -PassThru 
Invoke-LabCommand -ScriptBlock {Set-ExecutionPolicy Bypass -Scope Process -Force; choco install avastfreeantivirus -y -force} -ComputerName Client3 -PassThru


Restart-LabVM -ComputerName Client2
Restart-LabVM -ComputerName Client3

Show-LabDeploymentSummary -Detailed
